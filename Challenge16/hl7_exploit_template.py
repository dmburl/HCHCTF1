#!/usr/bin/env python3
"""
HL7 Message Sender - Exploit Template
Modify this to exploit the vulnerable HL7 handler
"""

import socket

def send_hl7_message(host, port, message):
    """Send HL7 message to server"""
    try:
        with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
            s.settimeout(10)
            s.connect((host, port))
            s.sendall(message.encode())
            
            response = s.recv(4096)
            print(f"Server response: {response.decode()}")
            
    except Exception as e:
        print(f"Error: {e}")

# Sample valid message for Elizabeth Hartwell
valid_message = """MSH|^~\&|HIS|SAINTCON|LAB|SAINTCON|20251021143000||ADT^A01|MSG00001|P|2.5
PID|1||VIP-7741||HARTWELL^ELIZABETH||19620315|F
PV1|1|I|304^A^01"""

# TODO: Modify the PV1 segment room field (field 3) to exploit the handler
# The vulnerability is in how the server validates room numbers
# Hint: Think about Python code injection...

exploit_message = """MSH|^~\&|HIS|SAINTCON|LAB|SAINTCON|20251021143000||ADT^A01|MSG00001|P|2.5
PID|1||VIP-7741||HARTWELL^ELIZABETH||19620315|F
PV1|1|I|YOUR_EXPLOIT_HERE^A^01"""

if __name__ == "__main__":
    TARGET_HOST = "YOUR_SERVER_IP"  # Change to CTF server IP
    TARGET_PORT = 2575
    
    print("="*60)
    print("SaintCon Hospital - HL7 Exploit Tool")
    print("="*60)
    print("\nTesting connection with valid message...")
    send_hl7_message(TARGET_HOST, TARGET_PORT, valid_message)
    
    print("\n" + "="*60)
    print("Ready to send exploit? Modify exploit_message first!")
    print("="*60)
    
    # Uncomment when you're ready to test your exploit:
    # send_hl7_message(TARGET_HOST, TARGET_PORT, exploit_message)